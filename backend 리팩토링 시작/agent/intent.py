"""
agent/intent.py - CAFE24 AI 운영 플랫폼 인텐트 키워드/유틸리티 (단일 소스)
============================================================
cross-6: 키워드/인텐트 분류에 쓰이는 키워드를 이 파일에서 단일 소스로 정의.
router.py, runner.py 모두 이 파일을 import하여 사용.

M14/M15/M16: 기존 detect_intent/run_deterministic_tools 제거.
L6: want_fraud_detection → SELLER 카테고리로 통합.
L7: LAST_CONTEXT_STORE → 미사용 제거.
"""
from typing import Optional, Dict, List


# ============================================================
# 카테고리별 분류 키워드 (단일 소스 - cross-6)
# ============================================================
ANALYSIS_KEYWORDS: List[str] = [
    "매출", "수익", "revenue", "arpu", "arppu", "과금", "성장률",
    "gmv", "거래액", "총거래", "거래 금액",
    "이탈", "churn", "고위험", "중위험", "저위험", "이탈률", "이탈 요인",
    "코호트", "cohort", "리텐션", "retention", "잔존", "week1", "week4",
    "트렌드", "trend", "kpi", "dau", "mau", "wau", "지표", "변화율",
    "활성 셀러", "신규 가입", "가입 추이", "전환율", "변화 분석", "추이 분석",
    "신규 쇼핑몰", "주문량", "주문 수", "결제 분석",
]

PLATFORM_KEYWORDS: List[str] = [
    # 핵심 플랫폼 키워드 (RAG 검색 필수)
    "플랫폼", "정책", "기능", "운영", "가이드", "도움말", "사용법",
    "정산", "정산 주기", "수수료", "배송비 정책", "반품 정책", "환불 정책",
    "앱스토어", "앱 연동", "API", "개발자", "테마", "디자인",
    "쇼핑몰 개설", "멀티쇼핑몰", "해외 배송", "글로벌 커머스",
    # 질문 패턴 (플랫폼 지식 요청)
    "뜻", "용어", "설명", "정의", "개념", "meaning", "definition",
    "뭐야", "무엇", "어떤", "알려줘", "어떻게 됐", "왜 그런",
]

SHOP_KEYWORDS: List[str] = [
    "쇼핑몰 정보", "쇼핑몰 서비스", "쇼핑몰 성과", "쇼핑몰 매출",
    "쇼핑몰 목록", "쇼핑몰 리스트", "쇼핑몰 현황", "쇼핑몰 분포",
    "쇼핑몰 플랜", "쇼핑몰 등급", "쇼핑몰 티어",
    "쇼핑몰 수", "쇼핑몰 개수", "쇼핑몰 몇", "쇼핑몰 통계",
    "전체 쇼핑몰", "총 쇼핑몰", "쇼핑몰 총",
    "샵 정보", "샵 성과", "샵 매출", "샵 목록", "shop",
    "카테고리별", "업종별", "티어별", "플랜별", "등급별",
    "카테고리 목록", "카테고리 전체", "카테고리 정보", "카테고리 현황",
    "업종 목록", "업종 전체", "업종 정보", "업종 현황",
    "패션", "뷰티", "식품", "가전", "리빙", "디지털",
    "프리미엄", "스탠다드", "베이직", "엔터프라이즈",
    "premium", "standard", "basic", "enterprise",
    "마케팅", "광고", "ROAS", "마케팅 최적화", "광고 전략",
]

SELLER_KEYWORDS: List[str] = [
    "셀러 분석", "셀러 정보", "셀러 이탈", "셀러 예측", "판매자 분석", "입점업체",
    "세그먼트", "군집",
    # 세그먼트 이름 (CSV 기준: 성장형/휴면/우수/파워/관리필요)
    "성장형 셀러", "휴면 셀러", "우수 셀러", "파워 셀러", "관리 필요 셀러",
    "성장형", "휴면", "관리 필요",
    # 이상/부정행위
    "이상 셀러", "부정행위", "이상 탐지", "이상거래", "이상 거래", "어뷰징", "사기", "비정상", "허위 주문", "리뷰 조작",
    "fraud", "anomaly", "부정 거래", "사기 탐지", "사기 거래",
]

CS_KEYWORDS: List[str] = [
    "CS", "고객 상담", "문의", "상담", "자동 응답", "자동응답",
    "환불", "반품", "교환", "배송 문의", "결제 문의",
    "CS 품질", "상담 품질", "용어집",
    "문의 분류", "카테고리 분류", "분류해", "티켓", "응답 생성",
    "결제 오류", "카드 오류", "배송 지연", "환불 요청", "교환 요청",
]

DASHBOARD_KEYWORDS: List[str] = [
    "대시보드", "dashboard", "전체 현황", "요약",
    "셀러 활동", "활동 현황", "주문 현황", "정산 현황",
    "운영 이벤트", "이벤트 통계", "이벤트 현황", "주문 이벤트", "정산 이벤트",
]

GENERAL_KEYWORDS: List[str] = [
    "안녕", "하이", "헬로", "hi", "hello",
    "고마워", "감사", "thanks",
    "뭐해", "누구", "자기소개",
]


# ============================================================
# 도구 강제 실행용 키워드-도구 매핑 (runner.py에서 사용)
# ============================================================
KEYWORD_TOOL_MAPPING: Dict[str, List[str]] = {
    "detect_fraud": ["부정행위 탐지", "비정상 셀러", "어뷰징", "사기 탐지", "허위 주문", "리뷰 조작"],
    "get_fraud_statistics": ["이상거래", "이상 거래", "이상 셀러", "부정행위 통계", "부정행위 현황", "사기 통계", "사기 현황", "fraud 통계", "부정 거래", "이상거래 탐지", "이상거래 현황"],
    "get_segment_statistics": ["세그먼트 통계", "셀러 세그먼트", "셀러 분포", "세그먼트 분석", "세그먼트 현황",
                               "성장형 셀러", "휴면 셀러", "우수 셀러", "파워 셀러", "관리 필요 셀러"],
    "get_order_statistics": ["운영 이벤트", "이벤트 통계", "주문 이벤트", "정산 이벤트", "이벤트 현황"],
    "get_cs_statistics": ["CS 통계", "상담 현황", "상담 품질", "CS 현황"],
    "classify_inquiry": ["카테고리 분류", "문의 분류", "분류해줘", "분류해 줘"],
    "get_dashboard_summary": ["대시보드", "전체 현황", "요약 통계", "셀러 활동", "활동 현황", "전체 셀러", "플랜별 분포", "등급별 분포", "티어별 분포", "전체 쇼핑몰", "쇼핑몰 수", "쇼핑몰 개수", "쇼핑몰 몇", "총 쇼핑몰"],
    # 쇼핑몰 목록/검색 도구
    "list_shops": ["쇼핑몰 목록", "쇼핑몰 리스트", "쇼핑몰 현황", "등급 쇼핑몰", "티어 쇼핑몰", "플랜 쇼핑몰"],
    "list_categories": ["카테고리 목록", "카테고리 전체", "카테고리 정보", "업종 목록", "업종 전체", "업종 정보", "업종 현황"],
    # ML 모델 예측 도구
    "predict_seller_churn": ["이탈 예측", "이탈 확률", "이탈 위험", "이탈률", "churn", "셀러 이탈"],
    "get_shop_performance": ["성과 분석", "쇼핑몰 성과", "쇼핑몰 매출", "성과 예측", "매출 분석"],
    "optimize_marketing": ["마케팅 추천", "마케팅 최적화", "광고 추천", "광고 전략", "마케팅 예산", "ROAS 최적화", "마케팅 예산 최적화", "광고 최적화", "마케팅 분석"],
    # 분석 도구
    "get_churn_prediction": ["이탈 분석", "이탈 현황", "이탈 통계", "고위험 셀러", "이탈 요인"],
    "get_cohort_analysis": ["코호트 분석", "리텐션 분석", "코호트 리텐션", "주간 리텐션", "잔존율"],
    "get_trend_analysis": ["트렌드 분석", "KPI 분석", "지표 분석", "DAU 분석", "상관관계", "활성 셀러", "가입 추이", "전환율", "신규 가입", "변화 분석", "추이 분석", "주문량 분석"],
    "get_gmv_prediction": ["매출 예측", "GMV 분석", "GMV 예측", "수익 분석", "ARPU", "ARPPU", "거래액"],
}


# ============================================================
# CS 문의 카테고리 추출 (유틸리티)
# ============================================================
def extract_cs_category(user_text: str) -> Optional[str]:
    """텍스트에서 CS 문의 카테고리를 추출합니다."""
    if not user_text:
        return None

    category_map = {
        "주문": "order", "order": "order", "주문 관련": "order",
        "배송": "delivery", "delivery": "delivery", "배송 관련": "delivery", "택배": "delivery",
        "환불": "refund", "refund": "refund", "환불 관련": "refund",
        "반품": "refund", "교환": "refund",
        "결제": "payment", "payment": "payment", "결제 관련": "payment", "카드": "payment",
        "상품": "product", "product": "product", "상품 관련": "product",
        "계정": "account", "account": "account", "로그인": "account", "비밀번호": "account",
    }

    t = user_text.lower()
    for keyword, cat_code in category_map.items():
        if keyword in t:
            return cat_code

    return "general"
